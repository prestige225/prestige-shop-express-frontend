<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Gestion des Produits</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold">
                        <i class="fas fa-cube mr-3"></i>
                        Administration - Produits
                    </h1>
                    <button onclick="window.location.href='admin.html'" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i> Retour
                    </button>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8">
            <!-- Formulaire d'ajout/édition de produit -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                    <i class="fas fa-plus-circle text-purple-600 mr-3"></i>
                    <span id="form-title">Ajouter un nouveau produit</span>
                </h2>
                
                <form id="product-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="product-id">
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nom du produit *</label>
                        <input type="text" id="product-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Prix (FCFA) *</label>
                        <input type="number" id="product-price" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Catégorie *</label>
                        <select id="product-category" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Sélectionnez une catégorie</option>
                            <option value="mode">Mode</option>
                            <option value="electronique">Électronique</option>
                            <option value="educatif">Éducatif</option>
                            <option value="fastfood">Fast Food</option>
                            <option value="mode de vie">Mode de vie</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Sous-catégorie</label>
                        <input type="text" id="product-subcategory" placeholder="Homme, Femme, Enfants, etc." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="product-description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">URL de l'image principale</label>
                        <input type="text" id="product-image" placeholder="https://example.com/image.jpg" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">URLs des images supplémentaires (séparées par des virgules)</label>
                        <input type="text" id="product-images" placeholder="https://example.com/image1.jpg,https://example.com/image2.jpg" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">URLs des vidéos (séparées par des virgules)</label>
                        <input type="text" id="product-videos" placeholder="https://example.com/video1.mp4,https://youtube.com/watch?v=...,https://vimeo.com/..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Formats supportés : MP4, YouTube, Vimeo, etc.</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tailles disponibles (séparées par des virgules)</label>
                        <input type="text" id="product-sizes" placeholder="S,M,L,XL" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Couleurs disponibles (séparées par des virgules)</label>
                        <input type="text" id="product-colors" placeholder="Rouge,Bleu,Noir" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Stock disponible</label>
                        <input type="number" id="product-stock" min="0" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Ordre d'affichage</label>
                        <input type="number" id="product-order" min="0" value="9999" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Plus le nombre est petit, plus le produit sera en haut</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Statut</label>
                        <select id="product-status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="actif">Actif</option>
                            <option value="inactif">Inactif</option>
                            <option value="rupture">Rupture de stock</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2 flex space-x-4">
                        <button type="submit" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white px-8 py-3 rounded-lg font-semibold transition-all transform hover:scale-105">
                            <i class="fas fa-save mr-2"></i>
                            <span id="submit-btn-text">Ajouter le produit</span>
                        </button>
                        <button type="button" onclick="resetForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition-all">
                            <i class="fas fa-times mr-2"></i>
                            Annuler
                        </button>
                    </div>
                </form>
            </div>

            <!-- Liste des produits -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-list text-blue-600 mr-3"></i>
                        Liste des produits
                    </h2>
                    <div class="flex space-x-4">
                        <input type="text" id="search-input" placeholder="Rechercher un produit..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Toutes les catégories</option>
                            <option value="mode">Mode</option>
                            <option value="electronique">Électronique</option>
                            <option value="educatif">Éducatif</option>
                            <option value="fastfood">Fast Food</option>
                            <option value="mode de vie">Mode de vie</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                </div>
                
                <div id="products-loading" class="text-center py-12 hidden">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Chargement des produits...</p>
                </div>
                
                <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Les produits seront chargés ici -->
                </div>
                
                <div id="no-products" class="text-center py-12 hidden">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-600 text-lg">Aucun produit trouvé</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // Configuration de l'API
        const API_BASE_URL = window.location.hostname.includes('render.com') || window.location.hostname.includes('onrender') 
            ? 'https://prestige-shop-backend.onrender.com/api'  // Pour l'environnement Render
            : 'http://localhost:5000/api';  // Pour le développement local

        let editingProduct = null;

        // Chargement des produits au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
        });

        // Chargement des produits
        async function loadProducts(filters = {}) {
            const container = document.getElementById('products-container');
            const loading = document.getElementById('products-loading');
            const noProducts = document.getElementById('no-products');
            
            loading.classList.remove('hidden');
            container.innerHTML = '';
            noProducts.classList.add('hidden');
            
            try {
                let url = `${API_BASE_URL}/produits`;
                const params = new URLSearchParams();
                
                if (filters.search) params.append('search', filters.search);
                if (filters.categorie) params.append('categorie', filters.categorie);
                
                if (params.toString()) {
                    url += `?${params.toString()}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.produits && data.produits.length > 0) {
                    data.produits.forEach(product => {
                        container.innerHTML += createProductCard(product);
                    });
                } else {
                    noProducts.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des produits:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                        <p class="text-red-600 text-lg">Erreur lors du chargement des produits</p>
                        <button onclick="loadProducts()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg">Réessayer</button>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Création d'une carte de produit
        function createProductCard(product) {
            const images = Array.isArray(product.images_urls) ? product.images_urls : 
                          (typeof product.images_urls === 'string' ? JSON.parse(product.images_urls) : []);
            // Si pas d'images dans le tableau, utiliser l'image principale
            if (images.length === 0 && product.image_url) {
                images.push(product.image_url);
            }
            const mainImage = images[0] || '/images/prestige-shop.png';
            
            const sizes = Array.isArray(product.taille_disponible) ? product.taille_disponible : 
                          (typeof product.taille_disponible === 'string' ? JSON.parse(product.taille_disponible) : []);
            const colors = Array.isArray(product.couleur_disponible) ? product.couleur_disponible : 
                           (typeof product.couleur_disponible === 'string' ? JSON.parse(product.couleur_disponible) : []);
            
            return `
                <div class="product-card bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-xl transition-all">
                    <div class="relative">
                        <!-- Carrousel d'images -->
                        <div class="carousel-container relative h-48 overflow-hidden">
                            <div class="carousel-track flex transition-transform duration-300 ease-in-out" id="carousel-${product.id}">
                                ${images.length > 0 ? images.map(img => `
                                    <div class="carousel-slide w-full flex-shrink-0">
                                        <img src="${img}" alt="${product.nom}" class="w-full h-48 object-cover">
                                    </div>
                                `).join('') : `
                                    <div class="carousel-slide w-full flex-shrink-0">
                                        <img src="/images/prestige-shop.png" alt="${product.nom}" class="w-full h-48 object-cover">
                                    </div>
                                `}
                            </div>
                            ${images.length > 1 ? `
                            <button onclick="prevSlide(${product.id}, ${images.length})" class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-75">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="nextSlide(${product.id}, ${images.length})" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-75">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-1">
                                ${images.map((_, idx) => `
                                    <button onclick="goToSlide(${product.id}, ${idx}, ${images.length})" class="w-2 h-2 rounded-full bg-white bg-opacity-50 hover:bg-opacity-100"></button>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                        <div class="absolute top-2 right-2">
                            <span class="bg-${product.statut === 'actif' ? 'green' : product.statut === 'rupture' ? 'red' : 'yellow'}-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                                ${product.statut}
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-gray-800 mb-2 line-clamp-2">${product.nom}</h3>
                        <p class="text-purple-600 font-bold text-lg">${product.prix?.toLocaleString() || 0} FCFA</p>
                        <p class="text-gray-600 text-sm mb-2">${product.categorie} ${product.sous_categorie ? `- ${product.sous_categorie}` : ''}</p>
                        <p class="text-gray-500 text-sm mb-3 line-clamp-2">${product.description || 'Aucune description'}</p>
                        
                        ${sizes.length > 0 ? `
                        <div class="mb-2">
                            <p class="text-xs font-semibold text-gray-700 mb-1">Tailles:</p>
                            <div class="flex flex-wrap gap-1">
                                ${sizes.slice(0, 3).map(size => `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${size}</span>`).join('')}
                                ${sizes.length > 3 ? `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">+${sizes.length - 3}</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${colors.length > 0 ? `
                        <div class="mb-3">
                            <p class="text-xs font-semibold text-gray-700 mb-1">Couleurs:</p>
                            <div class="flex flex-wrap gap-1">
                                ${colors.slice(0, 3).map(color => `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${color}</span>`).join('')}
                                ${colors.length > 3 ? `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">+${colors.length - 3}</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-sm text-gray-500">Stock: ${product.stock || 0}</span>
                            <div class="space-x-2">
                                <button onclick="editProduct(${product.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct(this.dataset.productId, this.dataset.productName)" data-product-id="${product.id}" data-product-name="${product.nom || ''}" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Variables pour gérer les carrousels
        let currentSlides = {};
        
        // Fonctions pour le carrousel
        function prevSlide(productId, totalSlides) {
            if (!currentSlides[productId]) currentSlides[productId] = 0;
            currentSlides[productId] = (currentSlides[productId] - 1 + totalSlides) % totalSlides;
            updateCarousel(productId, totalSlides);
        }
        
        function nextSlide(productId, totalSlides) {
            if (!currentSlides[productId]) currentSlides[productId] = 0;
            currentSlides[productId] = (currentSlides[productId] + 1) % totalSlides;
            updateCarousel(productId, totalSlides);
        }
        
        function goToSlide(productId, slideIndex, totalSlides) {
            currentSlides[productId] = slideIndex;
            updateCarousel(productId, totalSlides);
        }
        
        function updateCarousel(productId, totalSlides) {
            const carousel = document.getElementById(`carousel-${productId}`);
            if (carousel) {
                carousel.style.transform = `translateX(-${currentSlides[productId] * 100}%)`;
                
                // Mettre à jour les indicateurs
                const indicators = carousel.parentElement.querySelectorAll('.bg-white');
                indicators.forEach((indicator, idx) => {
                    if (idx === currentSlides[productId]) {
                        indicator.classList.remove('bg-opacity-50');
                        indicator.classList.add('bg-opacity-100');
                    } else {
                        indicator.classList.remove('bg-opacity-100');
                        indicator.classList.add('bg-opacity-50');
                    }
                });
            }
        }
        
        // Initialiser les positions des carrousels
        function initializeCarousels() {
            setTimeout(() => {
                document.querySelectorAll('[id^="carousel-"]').forEach(carousel => {
                    const productId = carousel.id.replace('carousel-', '');
                    if (!currentSlides[productId]) {
                        currentSlides[productId] = 0;
                    }
                });
            }, 100);
        }
        
        // Écouteur de formulaire
        document.getElementById('product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                nom: document.getElementById('product-name').value,
                prix: parseFloat(document.getElementById('product-price').value),
                categorie: document.getElementById('product-category').value,
                sous_categorie: document.getElementById('product-subcategory').value,
                description: document.getElementById('product-description').value,
                image_url: document.getElementById('product-image').value,
                images_urls: document.getElementById('product-images').value.split(',').map(url => url.trim()).filter(url => url),
                videos_urls: document.getElementById('product-videos').value.split(',').map(url => url.trim()).filter(url => url),
                taille_disponible: document.getElementById('product-sizes').value.split(',').map(size => size.trim()).filter(size => size),
                couleur_disponible: document.getElementById('product-colors').value.split(',').map(color => color.trim()).filter(color => color),
                stock: parseInt(document.getElementById('product-stock').value) || 0,
                ordre: parseInt(document.getElementById('product-order').value) || 9999,
                statut: document.getElementById('product-status').value
            };

            try {
                let response;
                if (editingProduct) {
                    // Mise à jour d'un produit existant
                    response = await fetch(`${API_BASE_URL}/produits/${editingProduct.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    document.getElementById('submit-btn-text').textContent = 'Ajouter le produit';
                } else {
                    // Création d'un nouveau produit
                    response = await fetch(`${API_BASE_URL}/produits`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }

                const result = await response.json();
                
                if (result.success) {
                    alert(editingProduct ? 'Produit mis à jour avec succès!' : 'Produit ajouté avec succès!');
                    resetForm();
                    loadProducts();
                } else {
                    alert('Erreur: ' + (result.message || 'Une erreur est survenue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de communication avec le serveur');
            }
        });

        // Édition d'un produit
        function editProduct(productId) {
            // Charger les détails du produit
            fetch(`${API_BASE_URL}/produits/${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const product = data.produit;
                        editingProduct = product;
                        
                        document.getElementById('product-id').value = product.id;
                        document.getElementById('product-name').value = product.nom || '';
                        document.getElementById('product-price').value = product.prix || '';
                        document.getElementById('product-category').value = product.categorie || '';
                        document.getElementById('product-subcategory').value = product.sous_categorie || product.subcategorie || '';
                        document.getElementById('product-description').value = product.description || '';
                        document.getElementById('product-image').value = product.image_url || '';
                        
                        // Remplir les champs avec les tableaux
                        document.getElementById('product-images').value = Array.isArray(product.images_urls) ? product.images_urls.join(',') : '';
                        document.getElementById('product-videos').value = Array.isArray(product.videos_urls) ? product.videos_urls.join(',') : '';
                        document.getElementById('product-sizes').value = Array.isArray(product.taille_disponible) ? product.taille_disponible.join(',') : '';
                        document.getElementById('product-colors').value = Array.isArray(product.couleur_disponible) ? product.couleur_disponible.join(',') : '';
                        
                        document.getElementById('product-stock').value = product.stock || 0;
                        document.getElementById('product-order').value = product.ordre || 9999;
                        document.getElementById('product-status').value = product.statut || 'actif';
                        
                        document.getElementById('form-title').textContent = 'Modifier le produit';
                        document.getElementById('submit-btn-text').textContent = 'Mettre à jour';
                        
                        // Faire défiler vers le formulaire
                        document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du produit:', error);
                    alert('Erreur lors du chargement du produit');
                });
        }

        // Suppression d'un produit
        function deleteProduct(productId, productName) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer le produit "${productName}" ?`)) {
                fetch(`${API_BASE_URL}/produits/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Produit supprimé avec succès!');
                        loadProducts();
                    } else {
                        alert('Erreur: ' + (result.message || 'Une erreur est survenue'));
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur de communication avec le serveur');
                });
            }
        }

        // Réinitialiser le formulaire
        function resetForm() {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            editingProduct = null;
            document.getElementById('form-title').textContent = 'Ajouter un nouveau produit';
            document.getElementById('submit-btn-text').textContent = 'Ajouter le produit';
        }

        // Filtrage et recherche
        document.getElementById('search-input').addEventListener('input', function() {
            const search = this.value.trim();
            const category = document.getElementById('category-filter').value;
            loadProducts({ search, categorie: category || undefined });
        });

        document.getElementById('category-filter').addEventListener('change', function() {
            const category = this.value;
            const search = document.getElementById('search-input').value.trim();
            loadProducts({ categorie: category || undefined, search: search || undefined });
        });
    </script>
</body>
</html>