<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Messages | Admin Prestige Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://use.fontawesome.com/releases/v6.0.0/css/all.css" rel="stylesheet">
    <script src="../api-config.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-envelope text-blue-600 mr-2"></i>Gestion des Messages
                </h1>
                <a href="admin.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                    ‚Üê Retour
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- PANNEAU GAUCHE: Filtres et S√©lection -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6 sticky top-20">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-filter mr-2"></i>Filtres & S√©lection
                    </h2>

                    <!-- Bouton Charger Utilisateurs -->
                    <button id="loadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg mb-4 transition">
                        <i class="fas fa-download mr-2"></i>Charger Utilisateurs
                    </button>

                    <!-- Filtres Avanc√©s -->
                    <div class="mb-4 pb-4 border-b space-y-3 max-h-96 overflow-y-auto">
                        <!-- Statut Profil -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Statut Profil :</label>
                            <select id="statutProfilFilter" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <option value="">Tous</option>
                                <option value="√âl√®ve">√âl√®ve</option>
                                <option value="√âtudiant">√âtudiant</option>
                                <option value="Parent">Parent</option>
                                <option value="Professeur">Professeur</option>
                                <option value="Travailleur">Travailleur</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>

                        <!-- Sexe -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Sexe :</label>
                            <select id="sexeFilter" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <option value="">Tous</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>

                        <!-- √Çge -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">√Çge :</label>
                            <div class="flex gap-2">
                                <input type="number" id="ageMinFilter" placeholder="Min" min="0" max="150"
                                    class="w-1/2 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <input type="number" id="ageMaxFilter" placeholder="Max" min="0" max="150"
                                    class="w-1/2 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Adresse -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Adresse :</label>
                            <input type="text" id="adresseFilter" placeholder="Chercher par ville/r√©gion..."
                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Centres d'int√©r√™t -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Centres d'int√©r√™t :</label>
                            <input type="text" id="centreInteret" placeholder="Chercher par int√©r√™t..."
                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Recherche Rapide -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Recherche Rapide :</label>
                            <input type="text" id="searchInput" placeholder="Nom/Email..."
                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Boutons S√©lection -->
                    <div class="flex gap-2 mb-4">
                        <button id="selectAllBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm font-bold transition">
                            ‚úì Tous
                        </button>
                        <button id="clearAllBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm font-bold transition">
                            ‚úó Aucun
                        </button>
                    </div>

                    <!-- Compteur -->
                    <div class="bg-blue-100 rounded-lg p-3 mb-4 text-center">
                        <p class="text-xs text-gray-600">S√©lectionn√©s</p>
                        <p class="text-3xl font-bold text-blue-600" id="selectedCount">0</p>
                    </div>

                    <!-- Liste Utilisateurs avec Checkboxes -->
                    <div class="border border-gray-300 rounded-lg max-h-96 overflow-y-auto p-2 bg-gray-50">
                        <div id="usersList" class="space-y-2">
                            <p class="text-gray-500 text-center py-8 text-sm">Cliquez sur "Charger" pour voir les utilisateurs</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PANNEAU DROIT: Formulaire Message -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-pen-fancy mr-2"></i>Composer le Message
                    </h2>

                    <form id="messageForm" class="space-y-5">
                        <!-- Objet Email -->
                        <div>
                            <label for="subject" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-heading mr-1"></i>Objet de l'Email *
                            </label>
                            <input type="text" id="subject" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Ex: Bienvenue chez Prestige Shop ! üéâ">
                            <p class="text-xs text-gray-500 mt-1">Ce titre appara√Æt dans la bo√Æte de r√©ception</p>
                        </div>

                        <!-- Corps Email -->
                        <div>
                            <label for="emailContent" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-file-alt mr-1"></i>Contenu de l'Email *
                            </label>
                            <textarea id="emailContent" rows="10" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-sans"
                                placeholder="Bonjour {{prenom}} {{nom}},

Bienvenue chez Prestige Shop Express !

Nous sommes heureux de vous compter parmi nos clients.

Visitez notre site : https://prestige-shop-express.onrender.com/

√Ä bient√¥t !
L'√©quipe Prestige Shop Express"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Variables disponibles : {{prenom}}, {{nom}}, {{email}}</p>
                        </div>

                        <!-- WhatsApp (optionnel) -->
                        <div>
                            <label for="whatsappContent" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fab fa-whatsapp mr-1"></i>Message WhatsApp (Optionnel)
                            </label>
                            <textarea id="whatsappContent" rows="3" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                placeholder="Bonjour {{prenom}}, bienvenue chez Prestige Shop ! üéâ"></textarea>
                        </div>

                        <!-- Confirmation -->
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                            <label class="flex items-center">
                                <input type="checkbox" id="confirmCheck" required class="h-5 w-5 text-yellow-600">
                                <span class="ml-3 text-sm text-gray-700">
                                    Je confirme l'envoi √† <strong id="confirmNumber">0</strong> utilisateur(s)
                                </span>
                            </label>
                        </div>

                        <!-- Boutons Action -->
                        <div class="flex gap-3">
                            <button type="submit" id="sendBtn" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                <i class="fas fa-paper-plane mr-2"></i>Envoyer les Messages
                            </button>
                            <button type="reset" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition">
                                <i class="fas fa-redo mr-2"></i>R√©initialiser
                            </button>
                        </div>
                    </form>

                    <!-- R√©sultats -->
                    <div id="resultDiv" class="mt-6 hidden p-5 bg-green-50 border-2 border-green-300 rounded-lg">
                        <h3 class="text-lg font-bold text-green-800 mb-4">
                            <i class="fas fa-check-circle mr-2"></i>Envoi R√©ussi ! ‚úÖ
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center p-3 bg-white rounded border border-green-200">
                                <p class="text-2xl font-bold text-green-600" id="emailCount">0</p>
                                <p class="text-xs text-gray-700">Emails</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded border border-green-200">
                                <p class="text-2xl font-bold text-green-600" id="whatsappCount">0</p>
                                <p class="text-xs text-gray-700">WhatsApp</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded border border-green-200">
                                <p class="text-2xl font-bold text-green-600">‚úì</p>
                                <p class="text-xs text-gray-700">Succ√®s</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let filteredUsers = [];
        let selectedIds = new Set();

        // Charger les utilisateurs avec les filtres avanc√©s
        document.getElementById('loadBtn').addEventListener('click', async () => {
            const btn = document.getElementById('loadBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Chargement...';
            
            try {
                // Construire les filtres
                const filters = {
                    statut: document.getElementById('statutProfilFilter').value || '',
                    sexe: document.getElementById('sexeFilter').value || '',
                    age_min: document.getElementById('ageMinFilter').value || '',
                    age_max: document.getElementById('ageMaxFilter').value || '',
                    adresse: document.getElementById('adresseFilter').value || '',
                    centre_interet: document.getElementById('centreInteret').value || ''
                };

                // Construire l'URL avec les param√®tres
                const queryString = new URLSearchParams(
                    Object.fromEntries(Object.entries(filters).filter(([_, v]) => v))
                ).toString();
                
                const endpoint = queryString 
                    ? `${API_BASE_URL}/users/filter?${queryString}`
                    : `${API_BASE_URL}/users/filter`;

                const response = await fetch(endpoint, { credentials: 'include' });
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success && data.users && data.users.length > 0) {
                    allUsers = data.users;
                    applyFilters();
                    btn.innerHTML = `<i class="fas fa-check mr-2"></i>${data.users.length} utilisateurs charg√©s`;
                    btn.className = 'w-full bg-green-600 text-white font-bold py-2 rounded-lg mb-4 transition disabled';
                } else if (data.success && data.users) {
                    alert('‚ö†Ô∏è Aucun utilisateur trouv√© avec ces crit√®res');
                    btn.innerHTML = '<i class="fas fa-download mr-2"></i>Charger Utilisateurs';
                    btn.disabled = false;
                } else {
                    alert('‚ùå Erreur : ' + (data.error || 'Impossible de charger les utilisateurs'));
                    btn.innerHTML = '<i class="fas fa-download mr-2"></i>Charger Utilisateurs';
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur de connexion : ' + error.message);
                btn.innerHTML = '<i class="fas fa-download mr-2"></i>Charger Utilisateurs';
                btn.disabled = false;
            }
        });

        // Appliquer les filtres et afficher
        function applyFilters() {
            const statutProfil = document.getElementById('statutProfilFilter').value;
            const sexe = document.getElementById('sexeFilter').value;
            const ageMin = parseInt(document.getElementById('ageMinFilter').value) || 0;
            const ageMax = parseInt(document.getElementById('ageMaxFilter').value) || 999;
            const adresse = document.getElementById('adresseFilter').value.toLowerCase();
            const centreInteret = document.getElementById('centreInteret').value.toLowerCase();
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredUsers = allUsers.filter(user => {
                // Filtres profil
                const matchStatutProfil = !statutProfil || user.statut_profil === statutProfil;
                const matchSexe = !sexe || user.sexe === sexe;
                const matchAge = (!ageMin || user.age >= ageMin) && (!ageMax || user.age <= ageMax);
                const matchAdresse = !adresse || (user.adresse && user.adresse.toLowerCase().includes(adresse));
                const matchCentre = !centreInteret || (user.centre_interet && user.centre_interet.toLowerCase().includes(centreInteret));
                
                // Recherche rapide
                const matchSearch = !search || 
                    user.prenom.toLowerCase().includes(search) ||
                    user.nom.toLowerCase().includes(search) ||
                    (user.email && user.email.toLowerCase().includes(search));

                return matchStatutProfil && matchSexe && matchAge && matchAdresse && matchCentre && matchSearch;
            });

            displayUsers();
        }

        // Afficher les utilisateurs
        function displayUsers() {
            const html = filteredUsers.map(user => `
                <label class="flex items-start p-2 hover:bg-blue-50 rounded cursor-pointer border border-gray-200 transition text-xs">
                    <input type="checkbox" class="userCheckbox h-4 w-4 text-blue-600 mt-0.5" value="${user.id}">
                    <div class="ml-2 flex-1 min-w-0">
                        <p class="font-medium text-gray-800">${user.prenom} ${user.nom}</p>
                        <p class="text-gray-500 truncate">${user.email || 'N/A'}</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${user.statut_profil ? `<span class="bg-blue-100 text-blue-800 px-1 rounded">${user.statut_profil}</span>` : ''}
                            ${user.sexe ? `<span class="bg-purple-100 text-purple-800 px-1 rounded">${user.sexe}</span>` : ''}
                            ${user.age ? `<span class="bg-orange-100 text-orange-800 px-1 rounded">${user.age}ans</span>` : ''}
                        </div>
                    </div>
                </label>
            `).join('');

            document.getElementById('usersList').innerHTML = html || '<p class="text-gray-500 text-center py-4 text-sm">Aucun utilisateur</p>';

            // Ajouter les listeners
            document.querySelectorAll('.userCheckbox').forEach(cb => {
                cb.checked = selectedIds.has(parseInt(cb.value));
                cb.addEventListener('change', updateCount);
            });
        }

        // Filtres - Ajouter les event listeners pour tous les filtres
        document.getElementById('statutProfilFilter').addEventListener('change', applyFilters);
        document.getElementById('sexeFilter').addEventListener('change', applyFilters);
        document.getElementById('ageMinFilter').addEventListener('input', applyFilters);
        document.getElementById('ageMaxFilter').addEventListener('input', applyFilters);
        document.getElementById('adresseFilter').addEventListener('input', applyFilters);
        document.getElementById('centreInteret').addEventListener('input', applyFilters);
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        // S√©lectionner/D√©s√©lectionner tout
        document.getElementById('selectAllBtn').addEventListener('click', () => {
            filteredUsers.forEach(u => selectedIds.add(u.id));
            document.querySelectorAll('.userCheckbox').forEach(cb => cb.checked = true);
            updateCount();
        });

        document.getElementById('clearAllBtn').addEventListener('click', () => {
            selectedIds.clear();
            document.querySelectorAll('.userCheckbox').forEach(cb => cb.checked = false);
            updateCount();
        });

        // Mettre √† jour le compteur
        function updateCount() {
            selectedIds.clear();
            document.querySelectorAll('.userCheckbox:checked').forEach(cb => {
                selectedIds.add(parseInt(cb.value));
            });
            
            const count = selectedIds.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('confirmNumber').textContent = count;
            document.getElementById('sendBtn').disabled = count === 0;
        }

        // Envoyer les messages
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedIds.size === 0) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un utilisateur');
                return;
            }

            if (!document.getElementById('confirmCheck').checked) {
                alert('‚ö†Ô∏è Veuillez cocher la confirmation avant d\'envoyer');
                return;
            }

            const selectedUsers = allUsers.filter(u => selectedIds.has(u.id));
            const subject = document.getElementById('subject').value;
            const emailContent = document.getElementById('emailContent').value;
            const whatsappContent = document.getElementById('whatsappContent').value;

            if (!subject.trim() || !emailContent.trim()) {
                alert('‚ö†Ô∏è L\'objet et le contenu de l\'email sont obligatoires');
                return;
            }

            // D√©sactiver le bouton pendant l'envoi
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi en cours...';

            try {
                const response = await fetch(`${API_BASE_URL}/messages/send-bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        users: selectedUsers,
                        subject: subject,
                        email_message: emailContent,
                        whatsapp_message: whatsappContent || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Afficher les r√©sultats
                    document.getElementById('resultDiv').classList.remove('hidden');
                    document.getElementById('emailCount').textContent = result.emailsSent || selectedUsers.length;
                    document.getElementById('whatsappCount').textContent = result.whatsappSent || 0;

                    // R√©initialiser apr√®s 3 secondes
                    setTimeout(() => {
                        document.getElementById('messageForm').reset();
                        selectedIds.clear();
                        updateCount();
                        document.getElementById('resultDiv').classList.add('hidden');
                        applyFilters();
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Envoyer les Messages';
                    }, 3000);
                } else {
                    alert('‚ùå Erreur : ' + (result.error || 'Impossible d\'envoyer les messages'));
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Envoyer les Messages';
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur de connexion : ' + error.message);
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Envoyer les Messages';
            }
        });

        updateCount();
    </script>
</body>
</html>
