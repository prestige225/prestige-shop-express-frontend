<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques de Visites - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 flex items-center">
            <i class="fas fa-chart-line mr-3 text-blue-600"></i>
            Statistiques de Visites
        </h1>
        
        <!-- Cartes de statistiques générales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 mr-4">
                        <i class="fas fa-eye text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Visites Totales</p>
                        <p id="totalVisits" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 mr-4">
                        <i class="fas fa-users text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Sessions Uniques</p>
                        <p id="uniqueSessions" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 mr-4">
                        <i class="fas fa-user-friends text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Visiteurs Uniques</p>
                        <p id="uniqueVisitors" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 mr-4">
                        <i class="fas fa-calendar text-yellow-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Première Visite</p>
                        <p id="firstVisit" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Graphique des visites par jour -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Visites par Jour</h2>
            <canvas id="dailyChart" height="200"></canvas>
        </div>
        
        <!-- Pages les plus visitées -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pages les Plus Visitées</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Page</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visites</th>
                        </tr>
                    </thead>
                    <tbody id="pageStats" class="bg-white divide-y divide-gray-200">
                        <!-- Les données seront insérées ici -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Détail des visites récentes -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Visites Récentes</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Page</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Referrer</th>
                        </tr>
                    </thead>
                    <tbody id="recentVisits" class="bg-white divide-y divide-gray-200">
                        <!-- Les données seront insérées ici -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration de l'API
        const API_BASE_URL = 'https://prestige-shop-backend.onrender.com/api';
        
        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/visits/stats`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalVisits').textContent = data.stats.total_visits;
                    document.getElementById('uniqueSessions').textContent = data.stats.unique_sessions;
                    document.getElementById('uniqueVisitors').textContent = data.stats.unique_visitors;
                    document.getElementById('firstVisit').textContent = data.stats.first_visit || '-';
                    
                    // Créer le graphique des visites par jour
                    createDailyChart(data.daily_stats);
                    
                    // Remplir les pages les plus visitées
                    fillPageStats(data.page_stats);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }
        
        // Charger les visites récentes
        async function loadRecentVisits() {
            try {
                const response = await fetch(`${API_BASE_URL}/visits?limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    fillRecentVisits(data.visits);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des visites récentes:', error);
            }
        }
        
        // Créer le graphique des visites par jour
        function createDailyChart(dailyStats) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            // Extraire les dates et les nombres de visites
            const dates = dailyStats.map(item => item.date);
            const counts = dailyStats.map(item => item.visits_count);
            
            // Inverser l'ordre pour avoir les dates récentes à droite
            dates.reverse();
            counts.reverse();
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Nombre de visites',
                        data: counts,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Remplir les pages les plus visitées
        function fillPageStats(pageStats) {
            const tbody = document.getElementById('pageStats');
            tbody.innerHTML = '';
            
            pageStats.forEach(page => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${page.page_visited}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${page.visit_count}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Remplir les visites récentes
        function fillRecentVisits(visits) {
            const tbody = document.getElementById('recentVisits');
            tbody.innerHTML = '';
            
            visits.forEach(visit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${visit.session_id.substring(0, 10)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${visit.ip_address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${visit.page_visited}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(visit.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${visit.referrer || 'Direct'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Charger les données au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadRecentVisits();
        });
    </script>
</body>
</html>